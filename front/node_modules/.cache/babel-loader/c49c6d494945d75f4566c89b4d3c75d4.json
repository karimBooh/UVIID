{"ast":null,"code":"import io from 'socket.io-client';\n\nclass Socket {\n  constructor() {\n    this.socket = void 0;\n    this.pc = {};\n    this.socketId = '';\n\n    this.init = (createOffer, partnerName) => {\n      this.pc[partnerName] = new RTCPeerConnection({\n        iceServers: [{\n          urls: [\"stun:eu-turn4.xirsys.com\"]\n        }, {\n          username: \"ml0jh0qMKZKd9P_9C0UIBY2G0nSQMCFBUXGlk6IXDJf8G2uiCymg9WwbEJTMwVeiAAAAAF2__hNSaW5vbGVl\",\n          credential: \"4dd454a6-feee-11e9-b185-6adcafebbb45\",\n          urls: [\"turn:eu-turn4.xirsys.com:80?transport=udp\", \"turn:eu-turn4.xirsys.com:3478?transport=tcp\"]\n        }]\n      });\n      /*if(screen && screen.getTracks().length){\n          screen.getTracks().forEach((track)=>{\n              this.pc[partnerName].addTrack(track, screen);//should trigger negotiationneeded event\n          });\n      }\n       else if(myStream){\n          myStream.getTracks().forEach((track)=>{\n              this.pc[partnerName].addTrack(track, myStream);//should trigger negotiationneeded event\n          });\n      }\n       else{\n          h.getUserFullMedia().then((stream)=>{\n              //save my stream\n              myStream = stream;\n               stream.getTracks().forEach((track)=>{\n                  this.pc[partnerName].addTrack(track, stream);//should trigger negotiationneeded event\n              });\n               h.setLocalStream(stream);\n          }).catch((e)=>{\n              console.error(`stream error: ${e}`);\n          });\n      }*/\n      //create offer\n\n      if (createOffer) {\n        this.pc[partnerName].onnegotiationneeded = async () => {\n          let offer = await this.pc[partnerName].createOffer();\n          await this.pc[partnerName].setLocalDescription(offer);\n          this.socket.emit('sdp', {\n            description: this.pc[partnerName].localDescription,\n            to: partnerName,\n            sender: this.socket.io.engine.id\n          });\n        };\n      } //send ice candidate to partnerNames\n\n\n      this.pc[partnerName].onicecandidate = ({\n        candidate\n      }) => {\n        this.socket.emit('ice candidates', {\n          candidate: candidate,\n          to: partnerName,\n          sender: this.socketId\n        });\n      }; //add\n\n      /*pc[partnerName].ontrack = (e)=>{\n          let str = e.streams[0];\n          if(document.getElementById(`${partnerName}-video`)){\n              document.getElementById(`${partnerName}-video`).srcObject = str;\n          }\n           else{\n              //video elem\n              let newVid = document.createElement('video');\n              newVid.id = `${partnerName}-video`;\n              newVid.srcObject = str;\n              newVid.autoplay = true;\n              newVid.className = 'remote-video';\n               //video controls elements\n              let controlDiv = document.createElement('div');\n              controlDiv.className = 'remote-video-controls';\n              controlDiv.innerHTML = `<i class=\"fa fa-microphone text-white pr-3 mute-remote-mic\" title=\"Mute\"></i>\n                      <i class=\"fa fa-expand text-white expand-remote-video\" title=\"Expand\"></i>`;\n               //create a new div for card\n              let cardDiv = document.createElement('div');\n              cardDiv.className = 'card card-sm';\n              cardDiv.id = partnerName;\n              cardDiv.appendChild(newVid);\n              cardDiv.appendChild(controlDiv);\n               //put div in main-section elem\n              document.getElementById('videos').appendChild(cardDiv);\n               h.adjustVideoElemSize();\n          }\n      };*/\n\n      /*this.pc[partnerName].onconnectionstatechange = (d)=>{\n          switch(this.pc[partnerName].iceConnectionState){\n              case 'disconnected':\n              case 'failed':\n                  h.closeVideo(partnerName);\n                  break;\n               case 'closed':\n                  h.closeVideo(partnerName);\n                  break;\n          }\n      };*/\n\n      /*this.pc[partnerName].onsignalingstatechange = (d)=>{\n          switch(this.pc[partnerName].signalingState){\n              case 'closed':\n                  console.log(\"Signalling state is 'closed'\");\n                  h.closeVideo(partnerName);\n                  break;\n          }\n      };*/\n\n    };\n  }\n\n  //   private myStream : MediaStream;\n  send() {\n    this.socket.emit('message', 'hi');\n  }\n\n  connect(room) {\n    if (this.socket && this.socket.connected) {\n      return;\n    }\n\n    this.socket = io('http://localhost:8080');\n    return new Promise(resolve => {\n      this.socket.on('connect', () => {\n        this.socketId = this.socket.io.engine.id;\n        this.socket.emit('subscribe', {\n          room: room,\n          socketId: this.socketId\n        });\n        this.socket.on('new user', data => {\n          this.socket.emit('newUserStart', {\n            to: data.socketId,\n            sender: this.socketId\n          });\n          this.init(true, data.socketId);\n        });\n        this.socket.on('newUserStart', data => {\n          this.init(false, data.sender);\n        });\n        this.socket.on('ice candidates', async data => {\n          if (data.candidate) await this.pc[data.sender].addIceCandidate(new RTCIceCandidate(data.candidate));\n        });\n        this.socket.on('sdp', async data => {\n          if (data.description.type === 'offer') {\n            if (data.desciption) await this.pc[data.sender].setRemoteDescription(new RTCSessionDescription(data.description));\n            /*h.getUserFullMedia().then(async (stream)=>{\n                if(!document.getElementById('local').srcObject){\n                    h.setLocalStream(stream);\n                }\n                 //save my stream\n                myStream = stream;\n                 stream.getTracks().forEach((track)=>{\n                    this.pc[data.sender].addTrack(track, stream);\n                });\n                 let answer = await this.pc[data.sender].createAnswer();\n                 await this.pc[data.sender].setLocalDescription(answer);\n                 this.socket.emit('sdp', {description:this.pc[data.sender].localDescription, to:data.sender, sender:socketId});\n            }).catch((e)=>{\n                console.error(e);\n            });*/\n          } else if (data.description.type === 'answer') {\n            await this.pc[data.sender].setRemoteDescription(new RTCSessionDescription(data.description));\n          }\n        });\n        resolve(this.socket);\n      });\n    });\n  }\n\n  disconnect() {\n    this.socket.emit('disconnect');\n    this.socket.close();\n  }\n\n}\n\nconst instance = new Socket();\nexport default instance;","map":{"version":3,"sources":["/home/rimkus/WebstormProjects/UVIID/front/src/Socket.tsx"],"names":["io","Socket","socket","pc","socketId","init","createOffer","partnerName","RTCPeerConnection","iceServers","urls","username","credential","onnegotiationneeded","offer","setLocalDescription","emit","description","localDescription","to","sender","engine","id","onicecandidate","candidate","send","connect","room","connected","Promise","resolve","on","data","addIceCandidate","RTCIceCandidate","type","desciption","setRemoteDescription","RTCSessionDescription","disconnect","close","instance"],"mappings":"AAAA,OAAOA,EAAP,MAAe,kBAAf;;AAMA,MAAOC,MAAP,CAAc;AAAA;AAAA,SACFC,MADE;AAAA,SAEFC,EAFE,GAEW,EAFX;AAAA,SAGFC,QAHE,GAGS,EAHT;;AAAA,SA6EVC,IA7EU,GA6EH,CAACC,WAAD,EAAuBC,WAAvB,KAA8C;AACjD,WAAKJ,EAAL,CAAQI,WAAR,IAAuB,IAAIC,iBAAJ,CAAsB;AAACC,QAAAA,UAAU,EAAE,CACtD;AACIC,UAAAA,IAAI,EAAE,CAAC,0BAAD;AADV,SADsD,EAItD;AACIC,UAAAA,QAAQ,EAAE,sFADd;AAEIC,UAAAA,UAAU,EAAE,sCAFhB;AAGIF,UAAAA,IAAI,EAAE,CACF,2CADE,EAEF,6CAFE;AAHV,SAJsD;AAAb,OAAtB,CAAvB;AAeA;;;;;;;;;;;;;;;;;;;;;;AA6BA;;AACA,UAAGJ,WAAH,EAAe;AACX,aAAKH,EAAL,CAAQI,WAAR,EAAqBM,mBAArB,GAA2C,YAAU;AACjD,cAAIC,KAAK,GAAG,MAAM,KAAKX,EAAL,CAAQI,WAAR,EAAqBD,WAArB,EAAlB;AAEA,gBAAM,KAAKH,EAAL,CAAQI,WAAR,EAAqBQ,mBAArB,CAAyCD,KAAzC,CAAN;AAEA,eAAKZ,MAAL,CAAYc,IAAZ,CAAiB,KAAjB,EAAwB;AAACC,YAAAA,WAAW,EAAC,KAAKd,EAAL,CAAQI,WAAR,EAAqBW,gBAAlC;AAAoDC,YAAAA,EAAE,EAACZ,WAAvD;AAAoEa,YAAAA,MAAM,EAAC,KAAKlB,MAAL,CAAYF,EAAZ,CAAeqB,MAAf,CAAsBC;AAAjG,WAAxB;AACH,SAND;AAOH,OAtDgD,CA0DjD;;;AACA,WAAKnB,EAAL,CAAQI,WAAR,EAAqBgB,cAArB,GAAsC,CAAC;AAACC,QAAAA;AAAD,OAAD,KAAe;AACjD,aAAKtB,MAAL,CAAYc,IAAZ,CAAiB,gBAAjB,EAAmC;AAACQ,UAAAA,SAAS,EAAEA,SAAZ;AAAuBL,UAAAA,EAAE,EAACZ,WAA1B;AAAuCa,UAAAA,MAAM,EAAC,KAAKhB;AAAnD,SAAnC;AACH,OAFD,CA3DiD,CAiEjD;;AACA;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAoCA;;;;;;;;;;;;AAeA;;;;;;;;;AAQH,KA1MS;AAAA;;AAIb;AAEGqB,EAAAA,IAAI,GAAG;AACH,SAAKvB,MAAL,CAAYc,IAAZ,CAAiB,SAAjB,EAA4B,IAA5B;AACH;;AAEDU,EAAAA,OAAO,CAACC,IAAD,EAAgB;AACnB,QAAI,KAAKzB,MAAL,IAAe,KAAKA,MAAL,CAAY0B,SAA/B,EAA0C;AACtC;AACH;;AACD,SAAK1B,MAAL,GAAcF,EAAE,CAAC,uBAAD,CAAhB;AACA,WAAO,IAAI6B,OAAJ,CAAYC,OAAO,IAAI;AAC1B,WAAK5B,MAAL,CAAY6B,EAAZ,CAAe,SAAf,EAA0B,MAAM;AAC5B,aAAK3B,QAAL,GAAgB,KAAKF,MAAL,CAAYF,EAAZ,CAAeqB,MAAf,CAAsBC,EAAtC;AAEA,aAAKpB,MAAL,CAAYc,IAAZ,CAAiB,WAAjB,EAA8B;AAC1BW,UAAAA,IAAI,EAAEA,IADoB;AAE1BvB,UAAAA,QAAQ,EAAE,KAAKA;AAFW,SAA9B;AAKA,aAAKF,MAAL,CAAY6B,EAAZ,CAAe,UAAf,EAA4BC,IAAD,IAAa;AACpC,eAAK9B,MAAL,CAAYc,IAAZ,CAAiB,cAAjB,EAAiC;AAACG,YAAAA,EAAE,EAACa,IAAI,CAAC5B,QAAT;AAAmBgB,YAAAA,MAAM,EAAC,KAAKhB;AAA/B,WAAjC;AACA,eAAKC,IAAL,CAAU,IAAV,EAAgB2B,IAAI,CAAC5B,QAArB;AACH,SAHD;AAMA,aAAKF,MAAL,CAAY6B,EAAZ,CAAe,cAAf,EAAgCC,IAAD,IAAc;AACzC,eAAK3B,IAAL,CAAU,KAAV,EAAiB2B,IAAI,CAACZ,MAAtB;AACH,SAFD;AAIA,aAAKlB,MAAL,CAAY6B,EAAZ,CAAe,gBAAf,EAAiC,MAAOC,IAAP,IAAmB;AAChD,cAAGA,IAAI,CAACR,SAAR,EACI,MAAM,KAAKrB,EAAL,CAAQ6B,IAAI,CAACZ,MAAb,EAAqBa,eAArB,CAAqC,IAAIC,eAAJ,CAAoBF,IAAI,CAACR,SAAzB,CAArC,CAAN;AACP,SAHD;AAMA,aAAKtB,MAAL,CAAY6B,EAAZ,CAAe,KAAf,EAAsB,MAAOC,IAAP,IAAoB;AACtC,cAAGA,IAAI,CAACf,WAAL,CAAiBkB,IAAjB,KAA0B,OAA7B,EAAqC;AACjC,gBAAIH,IAAI,CAACI,UAAT,EACI,MAAM,KAAKjC,EAAL,CAAQ6B,IAAI,CAACZ,MAAb,EAAqBiB,oBAArB,CAA0C,IAAIC,qBAAJ,CAA0BN,IAAI,CAACf,WAA/B,CAA1C,CAAN;AAEJ;;;;;;;;;;;;;;;AAoBH,WAxBD,MA0BK,IAAGe,IAAI,CAACf,WAAL,CAAiBkB,IAAjB,KAA0B,QAA7B,EAAsC;AACvC,kBAAM,KAAKhC,EAAL,CAAQ6B,IAAI,CAACZ,MAAb,EAAqBiB,oBAArB,CAA0C,IAAIC,qBAAJ,CAA0BN,IAAI,CAACf,WAA/B,CAA1C,CAAN;AACH;AACJ,SA9BD;AAgCAa,QAAAA,OAAO,CAAC,KAAK5B,MAAN,CAAP;AACH,OAzDD;AA0DH,KA3DM,CAAP;AA4DH;;AAiIDqC,EAAAA,UAAU,GAAG;AACT,SAAKrC,MAAL,CAAYc,IAAZ,CAAiB,YAAjB;AACA,SAAKd,MAAL,CAAYsC,KAAZ;AACH;;AA/MS;;AAkNd,MAAMC,QAAQ,GAAG,IAAIxC,MAAJ,EAAjB;AACA,eAAewC,QAAf","sourcesContent":["import io from 'socket.io-client'\n\ninterface IHash {\n    [socketid : string] : RTCPeerConnection\n}\n\nclass  Socket {\n    private socket : any;\n    private pc : IHash = {};\n    private socketId = '';\n //   private myStream : MediaStream;\n\n    send() {\n        this.socket.emit('message', 'hi');\n    }\n\n    connect(room : string) {\n        if (this.socket && this.socket.connected) {\n            return ;\n        }\n        this.socket = io('http://localhost:8080');\n        return new Promise(resolve => {\n            this.socket.on('connect', () => {\n                this.socketId = this.socket.io.engine.id;\n\n                this.socket.emit('subscribe', {\n                    room: room,\n                    socketId: this.socketId\n                });\n\n                this.socket.on('new user', (data: any)=>{\n                    this.socket.emit('newUserStart', {to:data.socketId, sender:this.socketId});\n                    this.init(true, data.socketId);\n                });\n\n\n                this.socket.on('newUserStart', (data : any)=>{\n                    this.init(false, data.sender);\n                });\n\n                this.socket.on('ice candidates', async (data: any)=>{\n                    if(data.candidate)\n                        await this.pc[data.sender].addIceCandidate(new RTCIceCandidate(data.candidate));\n                });\n\n\n                this.socket.on('sdp', async (data : any)=>{\n                    if(data.description.type === 'offer'){\n                        if (data.desciption)\n                            await this.pc[data.sender].setRemoteDescription(new RTCSessionDescription(data.description));\n\n                        /*h.getUserFullMedia().then(async (stream)=>{\n                            if(!document.getElementById('local').srcObject){\n                                h.setLocalStream(stream);\n                            }\n\n                            //save my stream\n                            myStream = stream;\n\n                            stream.getTracks().forEach((track)=>{\n                                this.pc[data.sender].addTrack(track, stream);\n                            });\n\n                            let answer = await this.pc[data.sender].createAnswer();\n\n                            await this.pc[data.sender].setLocalDescription(answer);\n\n                            this.socket.emit('sdp', {description:this.pc[data.sender].localDescription, to:data.sender, sender:socketId});\n                        }).catch((e)=>{\n                            console.error(e);\n                        });*/\n                    }\n\n                    else if(data.description.type === 'answer'){\n                        await this.pc[data.sender].setRemoteDescription(new RTCSessionDescription(data.description));\n                    }\n                });\n\n                resolve(this.socket);\n            });\n        });\n    }\n\n    init = (createOffer: boolean, partnerName: string) =>{\n        this.pc[partnerName] = new RTCPeerConnection({iceServers: [\n            {\n                urls: [\"stun:eu-turn4.xirsys.com\"]\n            },\n            {\n                username: \"ml0jh0qMKZKd9P_9C0UIBY2G0nSQMCFBUXGlk6IXDJf8G2uiCymg9WwbEJTMwVeiAAAAAF2__hNSaW5vbGVl\",\n                credential: \"4dd454a6-feee-11e9-b185-6adcafebbb45\",\n                urls: [\n                    \"turn:eu-turn4.xirsys.com:80?transport=udp\",\n                    \"turn:eu-turn4.xirsys.com:3478?transport=tcp\"\n                ]\n            }\n        ]\n    });\n\n        /*if(screen && screen.getTracks().length){\n            screen.getTracks().forEach((track)=>{\n                this.pc[partnerName].addTrack(track, screen);//should trigger negotiationneeded event\n            });\n        }\n\n        else if(myStream){\n            myStream.getTracks().forEach((track)=>{\n                this.pc[partnerName].addTrack(track, myStream);//should trigger negotiationneeded event\n            });\n        }\n\n        else{\n            h.getUserFullMedia().then((stream)=>{\n                //save my stream\n                myStream = stream;\n\n                stream.getTracks().forEach((track)=>{\n                    this.pc[partnerName].addTrack(track, stream);//should trigger negotiationneeded event\n                });\n\n                h.setLocalStream(stream);\n            }).catch((e)=>{\n                console.error(`stream error: ${e}`);\n            });\n        }*/\n\n\n\n        //create offer\n        if(createOffer){\n            this.pc[partnerName].onnegotiationneeded = async ()=>{\n                let offer = await this.pc[partnerName].createOffer();\n\n                await this.pc[partnerName].setLocalDescription(offer);\n\n                this.socket.emit('sdp', {description:this.pc[partnerName].localDescription, to:partnerName, sender:this.socket.io.engine.id});\n            };\n        }\n\n\n\n        //send ice candidate to partnerNames\n        this.pc[partnerName].onicecandidate = ({candidate})=>{\n            this.socket.emit('ice candidates', {candidate: candidate, to:partnerName, sender:this.socketId});\n        };\n\n\n\n        //add\n        /*pc[partnerName].ontrack = (e)=>{\n            let str = e.streams[0];\n            if(document.getElementById(`${partnerName}-video`)){\n                document.getElementById(`${partnerName}-video`).srcObject = str;\n            }\n\n            else{\n                //video elem\n                let newVid = document.createElement('video');\n                newVid.id = `${partnerName}-video`;\n                newVid.srcObject = str;\n                newVid.autoplay = true;\n                newVid.className = 'remote-video';\n\n                //video controls elements\n                let controlDiv = document.createElement('div');\n                controlDiv.className = 'remote-video-controls';\n                controlDiv.innerHTML = `<i class=\"fa fa-microphone text-white pr-3 mute-remote-mic\" title=\"Mute\"></i>\n                        <i class=\"fa fa-expand text-white expand-remote-video\" title=\"Expand\"></i>`;\n\n                //create a new div for card\n                let cardDiv = document.createElement('div');\n                cardDiv.className = 'card card-sm';\n                cardDiv.id = partnerName;\n                cardDiv.appendChild(newVid);\n                cardDiv.appendChild(controlDiv);\n\n                //put div in main-section elem\n                document.getElementById('videos').appendChild(cardDiv);\n\n                h.adjustVideoElemSize();\n            }\n        };*/\n\n\n\n        /*this.pc[partnerName].onconnectionstatechange = (d)=>{\n            switch(this.pc[partnerName].iceConnectionState){\n                case 'disconnected':\n                case 'failed':\n                    h.closeVideo(partnerName);\n                    break;\n\n                case 'closed':\n                    h.closeVideo(partnerName);\n                    break;\n            }\n        };*/\n\n\n\n        /*this.pc[partnerName].onsignalingstatechange = (d)=>{\n            switch(this.pc[partnerName].signalingState){\n                case 'closed':\n                    console.log(\"Signalling state is 'closed'\");\n                    h.closeVideo(partnerName);\n                    break;\n            }\n        };*/\n    }\n\n    disconnect() {\n        this.socket.emit('disconnect');\n        this.socket.close();\n    }\n}\n\nconst instance = new Socket();\nexport default instance\n"]},"metadata":{},"sourceType":"module"}